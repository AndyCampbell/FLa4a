#' @title S4 class \code{a4aFit}
#'
#' @description The \code{a4aFit} class was built to store the a4a stock assessment fits.
#'
#' @section Slots:
#' \describe{
#'    \item{call}{The function call}
#'
#'    \item{clock}{Information on call duration}
#'
#'    \item{fitSumm}{Fit summary}
#'
#'    \item{stock.n}{Estimates of stock numbers-at-age}
#'
#'    \item{harvest}{Estimates of fishing mortality at age}
#'
#'    \item{catch.n}{Estimates of catch numbers-at-age}
#'
#'    \item{index}{Estimates of survey or CPUE indices-at-age}
#'
#'  }
#' @template Accessors
#' @template Constructors
#' @docType class
#' @name a4aFit-class
#' @rdname a4aFit-class
#' @aliases a4aFit-class
#' @template Example-a4aFit

setClass("a4aFit",
        representation(
                "FLComp",
                call         = "call",
                clock        = "numeric",
                fitSumm      = "array",
                stock.n      = "FLQuant",
                harvest      = "FLQuant",
                catch.n      = "FLQuant",
                index        = "FLQuants"),
        prototype = prototype(
                call         = new('call'),
                clock        = new('numeric'),
                fitSumm      = new('array'),
                stock.n      = new('FLQuant'),
                harvest      = new('FLQuant'),
                catch.n      = new('FLQuant'),
                index        = new('FLQuants')),
        validity = function(object) {
			# All FLQuant objects must have same dimensions
			Dim <- dim(object@stock.n)
			if ((sum(dim(object@harvest) != Dim) + sum(dim(object@catch.n) != Dim))>=1)
				return("stock.n, catch.n and harvest slots must have same dimensions")
			# Everything is fine
			return(TRUE)}
)

#' @rdname a4aFit-class
#' @aliases a4aFit a4aFit-methods
setGeneric("a4aFit", function(object, ...) standardGeneric("a4aFit"))

#' @rdname a4aFit-class
#' @aliases a4aFit,missing-method
setMethod("a4aFit", signature(object="missing"),
  function(...) {
    # empty
  	if(missing(...)){
	  	new("a4aFit")
    # or not
  	} else {
      args <- list(...)
	  args$Class <- 'a4aFit'
      do.call("new", args)
	  }
  }
)

#' @rdname a4aFit-class
#' @aliases clock,a4aFit-method
setGeneric("clock", function(object, ...) standardGeneric("clock"))
setMethod("clock", "a4aFit", function(object) object@clock)

#' @rdname a4aFit-class
#' @aliases fitSumm fitSumm-methods fitSumm,a4aFit-method
setGeneric("fitSumm", function(object, ...) standardGeneric("fitSumm"))
setMethod("fitSumm", "a4aFit", function(object) object@fitSumm)

#' @rdname a4aFit-class
#' @aliases stock.n,a4aFit-method
setMethod("stock.n", "a4aFit", function(object) object@stock.n)

#' @rdname a4aFit-class
#' @aliases harvest,a4aFit-method
setMethod("harvest", "a4aFit", function(object) object@harvest)

#' @rdname a4aFit-class
#' @aliases catch.n,a4aFit-method
setMethod("catch.n", "a4aFit", function(object) object@catch.n)

#' @rdname a4aFit-class
#' @aliases index,a4aFit-method
setMethod("index", "a4aFit", function(object) object@index)

#' @rdname a4aFit-class
#' @aliases show,a4aFit-method
setMethod("show", signature(object = "a4aFit"),
  function(object) 
  {
    cat("a4a model fit for:", object@name, "\n")
    cat("\nCall:\n", paste(deparse(object @ call), sep = "\n", collapse = "\n"), 
        "\n\n", sep = "")

    cat("Time used:\n")
    print(object @ clock)
  
    #frmtQ <- function(x) {
    #  x <- as.matrix(drop(x @ .Data))
    #  if (ncol(x) > 8) {
    #    x[] <- paste(round(x,2))
    #    x <- x[,c(1:4,-2:0 + ncol(x))]
    #    x[,4] <- "..."
    #    colnames(x)[4] <- "..."
    #  }
    #  print(x, quote = FALSE)
    #}
    cat("\nPredicted F-at-age:\n")
      show(harvest(object))
    cat("\nPredicted stock numbers-at-age:\n")
      show(stock.n(object))
 })

#setMethod("show", signature(object = "a4aFit"),
#  function(object) 
#  {

#    cat("Formulas:\n")
#    cat("   log F", format(object@models$fmodel), "\n")
#    sapply(object@models$qmodel, function(m) cat("   log Q", format(m), "\n"))
#    cat("   log R", format(object@models$rmodel), "\n")

#    print(x$formula)
#    cat("Total model degrees of freedom", object@fit.sum["nopar"], "\n")
#    cat("   Residual degrees of freedom", object@fit.sum["nobs"] - object@fit.sum["nopar"], "\n")
#    cat("\nEstimated degrees of freedom:\n")
    #TODO check that nlogl is not 2 x neg loglik
#    cat("\n            AIC: ", AIC(object), sep = "")
#    cat("\n            BIC: ", BIC(object), sep = "")
#    cat("\n log Likelihood: ", c(logLik(object)), "\n", sep = "")
# })

#' @rdname a4aFit-class
#' @aliases logLik,a4aFit-method
setMethod("logLik", signature(object = "a4aFit"),
  function(object, ...) 
  {  
    dim2 <- length(dim(object @ fitSumm))
    if (dim2 == 1) {
      val <- -1 * unname(object @ fitSumm["nlogl"])
      attr(val, "nobs") <- unname(object @ fitSumm["nobs"])
      attr(val, "df") <- unname(object@fitSumm["nopar"])
    } else if (dim2 == 2) {
      val <- -1 * unname(object @ fitSumm["nlogl",])
      attr(val, "nobs") <- unname(object @ fitSumm["nobs",])
      attr(val, "df") <- unname(object@fitSumm["nopar",])
    }
    class(val) <- "logLik"
    val
 })

#====================================================================
# plural class for a4aFit (used for model averaging)
#====================================================================

#' @rdname a4aFit-class
#' @aliases a4aFits-class

setClass("a4aFits", 
	contains="FLComps",
	validity=function(object){
		if(!all(unlist(lapply(object, is, 'a4aFit'))))
			return("Components must be a4aFit")	
		return(TRUE)}
)

#' @rdname a4aFit-class
#' @aliases a4aFits a4aFits,list-methods
setGeneric("a4aFits", function(object, ...) standardGeneric("a4aFits"))
setMethod("a4aFits", signature(object="list"),
  function(object, ...) {
    args <- list(...)
    
    # names in args, ... 
    if("names" %in% names(args)) {
      names <- args[['names']]
    } else {
    # ... or in object,
      if(!is.null(names(object))) {
        names <- names(object)
    # ... or in elements, ...
      } else {
        names <- unlist(lapply(object, name))
        # ... or 1:n
        idx <- names == "NA" | names == ""
        if(any(idx))
          names[idx] <- as.character(length(names))[idx]
      }
    }

    # desc & lock
    args <- c(list(Class="a4aFits", .Data=object, names=names),
      args[!names(args)%in%'names'])

    return(
      do.call('new', args)
      )

})

#' @rdname a4aFit-class
#' @aliases a4aFits,a4aFit-methods
setMethod("a4aFits", signature(object="a4aFit"), function(object, ...) {
    lst <- c(object, list(...))
    a4aFits(lst)
})

#' @rdname a4aFit-class
#' @aliases a4aFits a4aFits,missing-methods
setMethod("a4aFits", signature(object="missing"),
  function(...) {
    # empty
  	if(missing(...)){
	  	new("a4aFits")
    # or not
  	} else {
      args <- list(...)
      object <- args[!names(args)%in%c('names', 'desc', 'lock')]
      args <- args[!names(args)%in%names(object)]
      do.call('a4aFits',  c(list(object=object), args))
	  }
  }
)


